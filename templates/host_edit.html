{{define "content"}}
<div class="mb-3">
    <a href="/admin/" class="btn btn-outline-secondary">&larr; Back to Hosts</a>
</div>

<h2>{{if .IsNew}}Add Host{{else}}Edit Host: {{.Host.Name}}{{end}}</h2>

<form action="/admin/host/{{if .IsNew}}new{{else}}{{.Host.Token}}{{end}}" method="POST">
    <div class="row">
        <div class="col-md-6 mb-3">
            <label for="name" class="form-label">Name</label>
            <input type="text" class="form-control" id="name" name="name" value="{{.Host.Name}}" required>
        </div>
        <div class="col-md-6 mb-3">
            <label for="token" class="form-label">Token (Unique ID)</label>
            <input type="text" class="form-control" id="token" name="token" value="{{.Host.Token}}" {{if not .IsNew}}readonly{{end}} placeholder="Auto-generated if empty">
        </div>
    </div>
    <div class="row">
        <div class="col-md-6 mb-3">
            <label for="domain" class="form-label">Domain</label>
            <input type="text" class="form-control" id="domain" name="domain" value="{{.Host.Domain}}">
        </div>
        <div class="col-md-6 mb-3">
            <label for="zone" class="form-label">Zone</label>
            <input type="text" class="form-control" id="zone" name="zone" value="{{.Host.Zone}}">
        </div>
    </div>
    <div class="row">
        <div class="col-md-6 mb-3">
            <label for="ip4addr" class="form-label">IPv4 Address</label>
            <input type="text" class="form-control" id="ip4addr" name="ip4addr" value="{{if .Host.Ip4addr}}{{.Host.Ip4addr}}{{end}}">
        </div>
        <div class="col-md-6 mb-3">
            <label for="ip6addr" class="form-label">IPv6 Address</label>
            <input type="text" class="form-control" id="ip6addr" name="ip6addr" value="{{if .Host.Ip6addr}}{{.Host.Ip6addr}}{{end}}">
        </div>
    </div>
    
    <button type="submit" class="btn btn-primary">Save Host</button>
    {{if not .IsNew}}
    <button type="button" class="btn btn-danger float-end" 
        hx-delete="/admin/host/{{.Host.Token}}" 
        hx-confirm="Are you sure you want to delete this host?"
        hx-target="body"
        hx-push-url="true">Delete Host</button>
    {{end}}
</form>

{{if not .IsNew}}
<hr class="my-5">

<div x-data="{ open: false }">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Update Methods</h3>
        <button class="btn btn-success btn-sm" @click="open = true" x-show="!open">Add Update Method</button>
    </div>

    <div x-show="open" class="card p-3 mb-3 bg-body-tertiary" style="display: none;">
        <h5>New Update Method</h5>
        <form hx-post="/admin/updates" hx-target="#updates-list" hx-swap="beforeend" @htmx:after-request="$el.reset(); open = false; document.getElementById('no-updates-row')?.remove()">
            <input type="hidden" name="token" value="{{.Host.Token}}">
            <div class="mb-2">
                <label class="form-label">Command (or 'GET' / 'cloudflare')</label>
                <input type="text" class="form-control" name="cmd" required>
            </div>
            <div class="mb-2">
                <label class="form-label">Args (URL or CLI args)</label>
                <input type="text" class="form-control" name="args">
            </div>
            <div class="mb-2">
                <label class="form-label">API Key Env Var (Optional)</label>
                <input type="text" class="form-control" name="api_key">
            </div>
            <button type="submit" class="btn btn-primary btn-sm">Add</button>
            <button type="button" class="btn btn-secondary btn-sm" @click="open = false">Cancel</button>
        </form>
    </div>
</div>

<table class="table table-bordered">
    <thead>
        <tr>
            <th>ID</th>
            <th>Command</th>
            <th>Args</th>
            <th>API Key Var</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody id="updates-list">
        {{range .Updates}}
        {{template "update_row" .}}
        {{else}}
        <tr id="no-updates-row"><td colspan="5" class="text-center text-muted">No update methods configured.</td></tr>
        {{end}}
    </tbody>
</table>
{{end}}

{{end}}

{{define "update_row"}}
<tr>
    <td>{{.Id}}</td>
    <td>{{.Cmd}}</td>
    <td>{{.Args}}</td>
    <td>{{if .ApiKey}}{{.ApiKey}}{{end}}</td>
    <td>
        <button class="btn btn-sm btn-danger" 
            hx-delete="/admin/updates/{{.Id}}" 
            hx-confirm="Delete this update method?" 
            hx-target="closest tr" 
            hx-swap="outerHTML">Delete</button>
    </td>
</tr>
{{end}}
